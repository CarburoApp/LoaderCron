# ğŸ•’ Carburo - Cron de ActualizaciÃ³n AutomÃ¡tica de Datos de Hidrocarburos (TFG)

## ğŸ“Š Calidad del CÃ³digo (SonarCloud)

**Estado General**

[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Lines of Code](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=ncloc)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

**Bugs y Vulnerabilidades**

[![Reliability Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=reliability_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Bugs](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=bugs)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Vulnerabilities](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=vulnerabilities)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Security Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=security_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

**Cobertura y Mantenibilidad**

[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=coverage)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Maintainability Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=sqale_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Technical Debt](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=sqale_index)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

---

## ğŸ“˜ IntroducciÃ³n

Este repositorio forma parte del **Trabajo de Fin de Grado (TFG)** de **Manuel GarcÃ­a Baldo** en la **Universidad de
Oviedo**.  
Su objetivo es **mantener actualizados los datos de estaciones de servicio y precios de combustibles en EspaÃ±a**,
obtenidos desde la **API de Hidrocarburos del MITMA**, para que estÃ©n disponibles y actualizados en la **aplicaciÃ³n
Android principal del proyecto**.

Este mÃ³dulo se ejecuta como un **cron programado cada 30 minutos**, que descarga, procesa y sincroniza la informaciÃ³n
con una **base de datos Supabase** (PostgreSQL).  
De esta forma, la aplicaciÃ³n Android puede consultar los datos mÃ¡s recientes sin depender directamente de la API
externa, mejorando la **disponibilidad, velocidad y fiabilidad**.

---

## âš™ï¸ Estructura general del proyecto

El proyecto incluye:

- **Sistema de cron**: Planificador automÃ¡tico que ejecuta las actualizaciones cada 30 minutos como un job.
- **MÃ³dulo HTTP**: Gestiona las peticiones y la recepciÃ³n de datos JSON.
- **Parsers JSON**: Transforman los datos obtenidos desde la API MITMA en entidades Java.
- **GestiÃ³n concurrente**: Procesamiento en paralelo de grandes volÃºmenes de datos para reducir el tiempo de
  actualizaciÃ³n.
- **Persistencia**: SincronizaciÃ³n eficiente con la base de datos Supabase usando operaciones por lotes.

---

## ğŸ”§ ConfiguraciÃ³n inicial

Antes de ejecutar el cron, **es imprescindible configurar correctamente las variables de entorno** relacionadas con la
conexiÃ³n a Supabase.

### Variables necesarias:

| Variable  | DescripciÃ³n                                 |
|-----------|---------------------------------------------|
| `DB_URL`  | DirecciÃ³n del host de la base de datos      |
| `DB_USER` | Usuario con permisos de lectura y escritura |
| `DB_PASS` | ContraseÃ±a correspondiente                  |


> âš ï¸ **Importante:**  
> Si estas variables no se definen correctamente, el cron **no podrÃ¡ establecer conexiÃ³n con la base de datos** y **no
se iniciarÃ¡ el proceso de actualizaciÃ³n**.

---

## ğŸ”„ Funcionamiento general

### â±ï¸ EjecuciÃ³n programada

El cron se activa automÃ¡ticamente **cada 30 minutos** mediante un planificador interno basado en
`ScheduledExecutorService`. La programaciÃ³n es configurable desde las properties del proyecto.

### ğŸŒ ObtenciÃ³n de datos

Realiza **peticiones HTTP** a la **API de Hidrocarburos del MITMA**, obteniendo un JSON con la informaciÃ³n de todas las
estaciones de servicio y precios actualizados.

### ğŸ§© Procesamiento y parseo

Los datos recibidos se transforman en entidades (`EESS`, `Municipio`, `Provincia`, etc.) mediante parsers dedicados.

### ğŸ’¾ Persistencia eficiente

Las entidades se sincronizan con la base de datos Supabase usando **operaciones por lotes (batch)** y **procesamiento
concurrente con hilos** para optimizar el rendimiento.

### ğŸ“‹ Registro de actividad

Cada ejecuciÃ³n genera logs detallados con:

- NÃºmero de estaciones procesadas.
- Errores detectados.
- Tiempo total de ejecuciÃ³n.

---

## âš ï¸ Principales desafÃ­os tÃ©cnicos

### ğŸ§µ GestiÃ³n de hilos y concurrencia

Uno de los mayores retos fue la **gestiÃ³n eficiente del gran volumen de datos** (mÃ¡s de 10.000 estaciones por
actualizaciÃ³n).  
Procesar y almacenar esta cantidad en un tiempo razonable requerÃ­a:

- Uso de `ExecutorService` y `CompletableFuture` para ejecuciÃ³n multihilo.
- Control estricto del nÃºmero de hilos concurrentes.
- SincronizaciÃ³n de colecciones compartidas.
- Cierre correcto de `EntityManager` y conexiones al finalizar cada tarea.

Sin estas medidas, aparecÃ­an **fugas de memoria**, **bloqueos** y **errores de conexiÃ³n**.  
El cÃ³digo actual implementa una soluciÃ³n robusta que equilibra concurrencia, rendimiento y estabilidad.

---

### ğŸŒ Problema con IPv4 e IPv6 en Supabase

Durante el desarrollo se detectÃ³ un problema crÃ­tico con la **resoluciÃ³n de direcciones IP**:

- El entorno local del cron usaba **IPv4**.
- Supabase, en su infraestructura actual, **solo acepta trÃ¡fico entrante por IPv6** en su versiÃ³n Online, con la que se
  empezÃ³ a trabajar.

Esto generaba errores de conexiÃ³n del tipo `Connection refused` o `timeout`, incluso con credenciales correctas.  
La causa estaba en la resoluciÃ³n DNS: el dominio de Supabase devolvÃ­a registros **AAAA (IPv6)**, mientras el entorno
local intentaba conectarse por IPv4.

#### âœ… SoluciÃ³n adoptada:

- Ejecutar el cron en entornos con **soporte IPv4 nativo**. Con la BD Supabase en un modo especial para poder aceptar
  conexiones IPV4.
- En entornos sin IPv6, usar **contenedores o mÃ¡quinas dual-stack (IPv4/IPv6)** para permitir la conexiÃ³n.

*En el sistema final la BD serÃ¡ local, en un servior porpio por lo que no habrÃ¡ este problema.

---

## ğŸ“± RelaciÃ³n con la aplicaciÃ³n Android del TFG

El cron actÃºa como **motor de actualizaciÃ³n** de los datos que la **aplicaciÃ³n Android del TFG** utiliza.  
La app permite a los usuarios:

- Consultar **precios actualizados** de combustibles (Gasolina 95, GasÃ³leo A, GLP, etc.).
- **Localizar estaciones** cercanas con mapas interactivos.
- Ver **horarios, direcciones y coordenadas**.
- Aplicar **filtros por tipo de combustible o ubicaciÃ³n**.

El cron garantiza que estos datos estÃ©n siempre actualizados en Supabase, sin depender directamente de la API MITMA (mÃ¡s
lenta y menos estable para uso en producciÃ³n).

---

## ğŸš€ Estado actual

- âœ… CÃ³digo operativo y funcional.
- âš™ï¸ Persistencia concurrente estable y validada.
- ğŸ”„ Sistema de cron en producciÃ³n cada 30 minutos.
- ğŸ§© Pendiente de optimizaciones menores y mejora del sistema de logs.

---

## ğŸ‘¨â€ğŸ’» Autor

**Manuel GarcÃ­a Baldo**  
Universidad de Oviedo  
Trabajo de Fin de Grado - IngenierÃ­a InformÃ¡tica (2025)

---

## ğŸ§¾ Licencia

Este proyecto se distribuye bajo licencia **MIT**.  
Puede utilizarse, modificarse o redistribuirse libremente, siempre que se cite la fuente original.
