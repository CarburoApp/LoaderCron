# ğŸ•’ Carburo - Cron de ActualizaciÃ³n AutomÃ¡tica de Datos de Hidrocarburos (TFG)

## ğŸ“Š Calidad del CÃ³digo (SonarCloud)

**Estado General**

[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Lines of Code](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=ncloc)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

**Bugs y Vulnerabilidades**

[![Reliability Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=reliability_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Bugs](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=bugs)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Vulnerabilities](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=vulnerabilities)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Security Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=security_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

**Cobertura y Mantenibilidad**

[![Coverage](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=coverage)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Maintainability Rating](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=sqale_rating)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)
[![Technical Debt](https://sonarcloud.io/api/project_badges/measure?project=CarburoApp_LoaderCron&metric=sqale_index)](https://sonarcloud.io/summary/new_code?id=CarburoApp_LoaderCron)

---

## ğŸ“˜ IntroducciÃ³n

Este repositorio forma parte del **Trabajo de Fin de Grado (TFG)** de **Manuel GarcÃ­a Baldo** en la **Universidad de
Oviedo**.  
Su objetivo es **mantener actualizados los datos de estaciones de servicio y precios de combustibles en EspaÃ±a**,
obtenidos desde la **API de Hidrocarburos del MITMA**, para que estÃ©n disponibles y actualizados en la **aplicaciÃ³n
Android principal del proyecto**.

Este mÃ³dulo se ejecuta como un **cron programado cada 30 minutos**, que descarga, procesa y sincroniza la informaciÃ³n
con una **base de datos Supabase** (PostgreSQL).  
De esta forma, la aplicaciÃ³n Android puede consultar los datos mÃ¡s recientes sin depender directamente de la API
externa, mejorando la **disponibilidad, velocidad y fiabilidad**.

---

## âš™ï¸ Estructura general del proyecto

El proyecto incluye:

- **Sistema de cron**: Planificador automÃ¡tico que ejecuta las actualizaciones cada 30 minutos como un job.
- **MÃ³dulo HTTP**: Gestiona las peticiones y la recepciÃ³n de datos JSON.
- **Parsers JSON -> DTO -> Entidades**: Transforman los datos obtenidos desde la API MITMA en entidades Java.
- **Persistencia**: SincronizaciÃ³n eficiente con la base de datos Supabase usando operaciones por lotes.
- **Servicio de Loggers**: Toda la ejecuciÃ³n queda registrada en los logs correspondientes.
- **Servicio de correo**: Dispone de un servicio de correo para enviar los resultados de la ejeuciÃ³n e informar de
  cualquier posible error durante su ejecuciÃ³n.

---

## ğŸ”§ ConfiguraciÃ³n inicial

Antes de ejecutar el cron, es **imprescindible configurar correctamente las variables de entorno** relacionadas con la
conexiÃ³n a la base de datos y, de manera opcional, el servicio de correo.

### 1ï¸âƒ£ Variables necesarias para la base de datos

| Variable  | DescripciÃ³n                                 |
|-----------|---------------------------------------------|
| `DB_URL`  | DirecciÃ³n del host de la base de datos      |
| `DB_USER` | Usuario con permisos de lectura y escritura |
| `DB_PASS` | ContraseÃ±a correspondiente                  |


> âš ï¸ **Importante:**  
> Si estas variables no se definen correctamente, los servicios **no podrÃ¡n establecer conexiÃ³n con la base de datos** y
**no se iniciarÃ¡ el proceso de actualizaciÃ³n**.

---

### 2ï¸âƒ£ Variables de entorno para el correo (opcional)

Para habilitar el envÃ­o de notificaciones por correo (alertas de errores o avisos importantes), se deben definir estas
variables de entorno:

| Variable            | DescripciÃ³n                                                      |
|---------------------|------------------------------------------------------------------|
| `ENV_MAIL_EMAIL`    | DirecciÃ³n de correo desde la que se enviarÃ¡n los mensajes        |
| `ENV_MAIL_PASSWORD` | ContraseÃ±a (mucho mejor Token de acceso) de la cuenta de correo  |
| `ENV_MAIL_TO_EMAIL` | DirecciÃ³n o lista de correos destinatarios de las notificaciones |

> âš ï¸ **RecomendaciÃ³n de seguridad:**
> - Nunca incluir la contraseÃ±a (`ENV_MAIL_PASSWORD`) directamente en el repositorio.
> - DefÃ­nela como variable de entorno en el servidor:

---

## ğŸ”„ Funcionamiento general

### â±ï¸ EjecuciÃ³n programada

El cron se activa automÃ¡ticamente **cada 30 minutos** mediante un planificador interno basado en
`ScheduledExecutorService` mediante la liberÃ­a de Quartz. La programaciÃ³n es configurable desde las properties del
proyecto.

### ğŸŒ ObtenciÃ³n de datos

Realiza **peticiones HTTP** a la **API de Hidrocarburos del MITMA**, obteniendo un JSON con la informaciÃ³n de todas las
estaciones de servicio y precios actualizados.

### ğŸ§© Procesamiento y parseo

Los datos recibidos se transforman en entidades (`EESS`, `Municipio`, `Provincia`, etc.) mediante parsers dedicados.

### ğŸ’¾ Persistencia eficiente

Las entidades se sincronizan con la base de datos Supabase usando **operaciones por lotes (batch)** o **procesamiento
concurrente con hilos** para optimizar el rendimiento.

### ğŸ“‹ Registro de actividad

Cada ejecuciÃ³n genera logs detallados con:

- NÃºmero de estaciones procesadas.
- Errores detectados.
- Tiempo total de ejecuciÃ³n.
- etc

---

## âš ï¸ Principales desafÃ­os tÃ©cnicos

### ğŸŒ Problema con IPv4 e IPv6 en Supabase

Durante el desarrollo se detectÃ³ un problema crÃ­tico con la **resoluciÃ³n de direcciones IP**:

- El entorno local del cron usaba **IPv4**.
- Supabase, en su infraestructura actual, **solo acepta trÃ¡fico entrante por IPv6** en su versiÃ³n Online, con la que se
  empezÃ³ a trabajar.

Esto generaba errores de conexiÃ³n del tipo `Connection refused` o `timeout`, incluso con credenciales correctas.  
La causa estaba en la resoluciÃ³n DNS: el dominio de Supabase devolvÃ­a registros **AAAA (IPv6)**, mientras el entorno
local intentaba conectarse por IPv4.

#### âœ… SoluciÃ³n adoptada:

- Ejecutar el cron en entornos con **soporte IPv4 nativo**. Con la BD Supabase en un modo especial para poder aceptar
  conexiones IPV4.
- En entornos sin IPv6, usar **contenedores o mÃ¡quinas dual-stack (IPv4/IPv6)** para permitir la conexiÃ³n.

*En el sistema final la BD serÃ¡ local, en un servior propio por lo que no habrÃ¡ este problema.

---

## ğŸ“± RelaciÃ³n con la aplicaciÃ³n Android del TFG

El cron actÃºa como **motor de actualizaciÃ³n** de los datos que la **aplicaciÃ³n Android del TFG** utiliza.  
La app permite a los usuarios:

- Consultar **precios actualizados** de combustibles (Gasolina 95, GasÃ³leo A, GLP, etc.).
- **Localizar estaciones** cercanas con mapas interactivos.
- Ver **horarios, direcciones y coordenadas**.
- Aplicar **filtros por tipo de combustible o ubicaciÃ³n**.

El cron garantiza que estos datos estÃ©n siempre actualizados en Supabase, sin depender directamente de la API MITMA (mÃ¡s
lenta y menos estable para uso en producciÃ³n).

---

## ğŸš€ Estado actual

- âœ… CÃ³digo operativo y funcional.
- âš™ï¸ Persistencia estable y validada.
- ğŸ”„ Sistema de cron en producciÃ³n cada 30 minutos.
- ğŸ§© Pendiente de optimizaciones menores y mejora del sistema de logs.

---

## ğŸ› ï¸ Sistema de despliegue

El despliegue de los servicios *cron* y *backend* en el servidor se realiza mediante un **sistema de auto-actualizaciÃ³n
automÃ¡tica**.  
Este sistema se encarga de:

- Comprobar periÃ³dicamente si hay nuevas releases publicadas en GitHub.
- Descargar y reemplazar los JAR correspondientes.
- Reiniciar los servicios de forma segura.
- Garantizar arranque automÃ¡tico tras reinicios del servidor.

Este enfoque permite mantener los servicios **actualizados y seguros** sin exponer puertos ni la IP del servidor,
evitando la necesidad de CI/CD remoto que conecte directamente con la infraestructura.

> Para ver todos los detalles de configuraciÃ³n, scripts, servicios systemd y timers, consulta el repositorio completo:  
> [Server-Cron-Backend-AutoUpdate](https://github.com/CarburoApp/Server-Cron-Backend-AutoUpdate.git)

---

## âš™ï¸ ConfiguraciÃ³n del Cron

El cron dispone de **archivos de propiedades** que permiten ajustar su comportamiento y adaptarlo a diferentes entornos
o bases de datos.

### Archivos principales

1. **`application.properties`**  
   Contiene la configuraciÃ³n general del cron, incluyendo conexiÃ³n a la base de datos, parÃ¡metros del scheduler, logging
   y correo.

2. **`queries.properties`**  
   Contiene las consultas SQL que se ejecutan para sincronizar los datos con la base de datos.
   > âš ï¸ Si cambias la estructura de la BD o deseas personalizar las consultas, aquÃ­ es donde se deben adaptar.

3. **Endpoints de la API**  
   Los endpoints utilizados para obtener los datos desde la API del MITMA estÃ¡n definidos dentro del proyecto y pueden
   modificarse si fuese necesario cambiar la fuente de datos.

### Uso de la carpeta `/config`

- Si existe la carpeta `/config` dentro del directorio donde se encuentra el cron, **el servicio cargarÃ¡ los archivos de ahÃ­**.
- Si no existe, el cron **usarÃ¡ los valores por defecto** incluidos en el JAR, debiendo, aÃºn asÃ­, introducir las variables de entorno.
- Esto permite:
  - Mantener configuraciones personalizadas sin modificar el JAR original.
  - Adaptar queries, endpoints o propiedades generales de forma sencilla segÃºn el entorno.

> ğŸ”¹ **RecomendaciÃ³n:**  
> Puedes crear tus propias versiones de `application.properties`, `queries.properties` y `endpoints.properties` dentro de `/config` para ajustar el cron a entornos especÃ­ficos, bases de datos distintas o cambios en la API.

---

## ğŸ‘¨â€ğŸ’» Autor

**Manuel GarcÃ­a Baldo**  
Universidad de Oviedo  
Trabajo de Fin de Grado - IngenierÃ­a InformÃ¡tica (2025)

---

## ğŸ§¾ Licencia

Este proyecto se distribuye bajo licencia **MIT**.  
Puede utilizarse, modificarse o redistribuirse libremente, siempre que se cite la fuente original.
